<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Dashboard Administrador - NAPESE</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cadastro_terapeuta.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/formulario_napese.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="shortcut icon" type="imagex/png" href="{{ url_for('static', filename='images/logo_subfooter.png') }}">
</head>
<body>
    <div class="bg-top"></div>
    <div class="bg-bottom"></div>

    <div class="admin-container">
        <div class="admin-header">
            <div class="logout-button">
                <a class="btn-action" href="{{ url_for('selecao_perfil') }}"><i class="fas fa-arrow-right-from-bracket"></i> Sair</a>
            </div>
            <img src="{{ url_for('static', filename='images/logo_rodape.png') }}" alt="Logo NAPESE" class="logo">
            <h1>Painel Administrativo</h1>
        </div>

        <div class="admin-content">
            <div class="admin-section">
                <div class="section-header">
                    <h2><i class="fas fa-users"></i> Usuários Ativos</h2>
                    <button onclick="openCreateUserModal()" class="btn-action">
                        <i class="fas fa-plus"></i> Novo Usuário
                    </button>
                </div>

                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="filtro-tabela" oninput="filtrarTabela()" placeholder="Buscar usuários...">
                </div>

                <div class="tables-container">
                    <div class="table-section">
                        <h3>Administradores e Terapeutas</h3>
                        <div class="table-container">
                            <table class="user-table" id="admin-terapeuta-table">
                                <thead>
                                    <tr>
                                        <th>Nome Completo</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in usuarios['items'] %}
                                        {% if user.tipo_usuario in ['admin', 'terapeuta'] %}
                                        <tr>
                                            <td>{{ user.email }}</td>
                                            <td class="actions-cell">
                                                <button class="action-btn edit-btn" 
                                                    onclick="openEditUserModal('{{ user.id }}', '{{ user.email }}')" 
                                                    title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <form action="{{ url_for('remover_usuario', user_id=user.id) }}" 
                                                    method="POST" 
                                                    style="display:inline;">
                                                    {{ form.csrf_token }}
                                                    <button type="submit" 
                                                            class="action-btn delete-btn" 
                                                            onclick="return confirm('Tem certeza que deseja remover este usuário?')" 
                                                            title="Remover">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </form>
                                                {% if user.tipo_usuario == 'terapeuta' %}
                                                    <button class="action-btn link-btn" 
                                                            onclick="openVincularPacientesModal('{{ user.id }}')"
                                                            title="Vincular Pacientes">
                                                        <i class="fas fa-link"></i>
                                                    </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="admin-terapeuta-pagination">
                            <button onclick="changePage('admin-terapeuta', -1)" class="btn-page">
                                <i class="fas fa-chevron-left"></i> Anterior
                            </button>
                            <span class="page-info">Página <span id="admin-terapeuta-current-page">1</span></span>
                            <button onclick="changePage('admin-terapeuta', 1)" class="btn-page">
                                Próxima <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <div class="table-section">
                        <h3>Pacientes</h3>
                        <div class="table-container">
                            <table class="user-table" id="paciente-table">
                                <thead>
                                    <tr>
                                        <th>Nome Completo</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in usuarios['items'] %}
                                        {% if user.tipo_usuario == 'paciente' %}
                                        <tr>
                                            <td>{{ user.nome_completo }}</td>
                                            <td class="actions-cell">
                                                <button class="action-btn edit-btn" 
                                                    onclick="openEditUserModal('{{ user.id }}', '{{ user.email }}')" 
                                                    title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <form action="{{ url_for('remover_usuario', user_id=user.id) }}" 
                                                    method="POST" 
                                                    style="display:inline;">
                                                    {{ form.csrf_token }}
                                                    <button type="submit" 
                                                            class="action-btn delete-btn" 
                                                            onclick="return confirm('Tem certeza que deseja remover este usuário?')" 
                                                            title="Remover">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </form>
                                                <form action="{{ url_for('gerar_pdf', user_email=user.email) }}" 
                                                    method="GET" 
                                                    style="display:inline;">
                                                    <button type="submit" 
                                                            class="action-btn pdf-btn" 
                                                            title="Gerar PDF">
                                                        <i class="fas fa-file-pdf"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                        {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="paciente-pagination">
                            <button onclick="changePage('paciente', -1)" class="btn-page">
                                <i class="fas fa-chevron-left"></i> Anterior
                            </button>
                            <span class="page-info">Página <span id="paciente-current-page">1</span></span>
                            <button onclick="changePage('paciente', 1)" class="btn-page">
                                Próxima <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="tables-container">
                    <div class="table-section">
                        <div class="section-header">
                            <h2><i class="fas fa-link"></i> Vínculos Terapeuta-Paciente</h2>
                        </div>
                
                        <div class="table-container">
                            <table class="user-table" id="vinculos-table">
                                <thead>
                                    <tr>
                                        <th>Terapeuta</th>
                                        <th>Paciente</th>
                                        <th>Data do Vínculo</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for vinculo in vinculos['items'] %}
                                    <tr>
                                        <td>{{ vinculo.nome_terapeuta }}</td>
                                        <td>{{ vinculo.nome_paciente }}</td>
                                        <td>{{ vinculo.data_vinculo }}</td>
                                        <td>
                                            <span class="badge badge-{{ 'terapeuta' if vinculo.status_vinculo == 'Ativo' else 'paciente' }}">
                                                {{ vinculo.status_vinculo }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="vinculos-pagination">
                            <button onclick="changePage('vinculos', -1)" class="btn-page">
                                <i class="fas fa-chevron-left"></i> Anterior
                            </button>
                            <span class="page-info">Página <span id="vinculos-current-page">1</span></span>
                            <button onclick="changePage('vinculos', 1)" class="btn-page">
                                Próxima <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="admin-section">
                <div class="section-header">
                    <h2><i class="fas fa-clock"></i> Pacientes Pendentes</h2>
                    <button onclick="pacientes_reprovados_excel()" class="btn-warn">
                        <i class="fas fa-download"></i> Listar pacientes reprovados
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="user-table" id="user-table">
                            <thead>
                                <tr>
                                    <th >ID</th>
                                    <th>Nome Completo</th>
                                    <th>Email</th>
                                    <th>Data do Cadastro</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in pacientes_pendentes['items'] %}
                                    <tr>
                                        <td>{{ user.id }}</td>
                                        <td>{{ user.nome_completo }}</td>
                                        <td>{{ user.email }}</td>
                                        <td>{{ user.data_cadastro }}</td>
                                        <td>
            
                                            
                                            <button onclick="openAvaliarPacienteModal('{{ user.id }}', '{{ user.email }}')"  
                                                    class="action-btn pdf-btn" 
                                                    title="Avaliar Paciente">
                                                    <i class="fa-solid fa-folder-open"></i>
                                            </button>
                                                
                            
                                            <!-- Botão de remover com tooltip -->
                                            <form action="{{ url_for('remover_usuario', user_id=user.id) }}"
                                                method="POST" 
                                                style="display:inline;">
                                                {{ form.csrf_token }}
                                                <button type="submit"
                                                        class="action-btn delete-btn" 
                                                        onclick="return confirm('Tem certeza que deseja remover este usuário?')" 
                                                        title="Remover">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                        </tbody>    
                    </table>    
                </div>
            </div>

            <div class="admin-section">
                <div class="section-header">
                    <h2><i class="fas fa-user-plus"></i> Terapeutas Pendentes</h2>
                    <button onclick="terapeutas_reprovados_excel()" class="btn-warn">
                        <i class="fas fa-download"></i> Listar terapeutas reprovados
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="user-table" id="user-table">
                            <thead>
                                <tr>
                                    <th >ID</th>
                                    <th>Nome Completo</th>
                                    <th>Email</th>
                                    <th>Data do Cadastro</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in terapeutas_pendentes['items'] %}
                                    <tr>
                                        <td>{{ user.id }}</td>
                                        <td>{{ user.nome_completo }}</td>
                                        <td>{{ user.email }}</td>
                                        <td>{{ user.data_cadastro }}</td>
                                        <td>
            
                                            
                                            <button onclick="openAvaliarTerapeutaModal('{{ user.id }}', '{{ user.email }}')"  
                                                    class="action-btn pdf-btn" 
                                                    title="Avaliar Terapeuta">
                                                    <i class="fa-solid fa-folder-open"></i>
                                            </button>
                                                
                            
                                            <!-- Botão de remover com tooltip -->
                                            <form action="{{ url_for('remover_usuario', user_id=user.id) }}"
                                                method="POST" 
                                                style="display:inline;">
                                                {{ form.csrf_token }}
                                                <button type="submit"
                                                        class="action-btn delete-btn" 
                                                        onclick="return confirm('Tem certeza que deseja remover este usuário?')" 
                                                        title="Remover">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                        </tbody>    
                    </table>    
                </div>
            </div>
        </div>
    </div>

    <!-- Modais existentes com novo estilo -->

    <!-- Modal de Vincular Pacientes -->
    <div id="vincularPacientesModal" style="display:none;">
        <div class="modal-content form-section">
            <div class="modal-header">
                <h3><i class="fas fa-link"></i> Vincular Pacientes</h3>
                <span class="close" onclick="closeVincularPacientesModal()">&times;</span>
            </div>
            
            <div class="modal-body">
                <div class="pacientes-vinculados">
                    <h4><i class="fas fa-users"></i> Pacientes Vinculados</h4>
                    <div class="pacientes-list" id="pacientes-ul">
                        <!-- Lista de pacientes vinculados será inserida aqui -->
                    </div>
                </div>
                
                <div class="vincular-novo">
                    <h4><i class="fas fa-user-plus"></i> Adicionar Novo Paciente</h4>
                    <form id="vincularPacientesForm" onsubmit="vincularPaciente(event)">
                        {{ form.csrf_token }}
                        <input type="hidden" id="terapeuta_id" name="terapeuta_id">
                        <div class="select-wrapper">
                            <select id="novo_paciente" name="novo_paciente" required>
                                <option value="" disabled selected>Selecione um paciente</option>
                            </select>
                        </div>
                        <button type="submit" class="btn-vincular">
                            <i class="fas fa-plus"></i> Vincular Paciente
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edição -->
    <div id="editModal" style="display:none;">
        <div class="modal-content form-section">
            <span class="close" onclick="closeEditUserModal()">&times;</span>
            <h3>Editar Usuário</h3>
            <form action="{{ url_for('editar_usuario') }}" method="POST">
                {{ form.csrf_token }}
                
                <input type="hidden" id="user_id" name="user_id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="password">Senha:</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                </div>


                <div>
                    <button type="submit" class="action-btn edit-btn">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Criação de Novo Usuário -->
    <div id="createUserModal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeCreateUserModal()">&times;</span>
            <h3>Criar Novo Usuário</h3>
            <form action="{{ url_for('criar_usuario') }}" method="POST">
                {{ form.csrf_token }}
                <div class="form-row">
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="tipo_usuario">Tipo de Usuário:</label>
                        <select id="tipo_usuario" name="tipo_usuario" required>
                            <option value="admin">Administrador</option>
                            <option value="terapeuta">Terapeuta</option>
                            <option value="paciente">Paciente</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="password">Senha:</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                </div>

                <div>
                    <button type="submit" class="action-btn edit-btn">Criar Usuário</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Avaliar Terapeuta -->
    <div id="avaliarTerapeutaModal" style="display:none;">
        <div class="modal-content-lg form-section">
            <span class="close" onclick="closeAvaliarTerapeutaModal()">&times;</span>
            

            <div class="form-section">
                <h3>Informações Pessoais</h3>
                <input type="hidden" id="avaliar_terapeuta_id" name="avaliar_terapeuta_id">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome Completo</label>
                        <input type="text" id="terapeuta_nome_completo" name="terapeuta_nome_completo" disabled>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="cidade">Cidade</label>
                        <input type="text" id="terapeuta_cidade" name="terapeuta_cidade" disabled>
                    </div>
                    <div class="form-group">
                        <label for="estado">Estado</label>
                        <select id="terapeuta_estado" name="terapeuta_estado" disabled>
                            <option value="">Selecione o Estado</option>
                            <option value="AC">Acre</option>
                            <option value="AL">Alagoas</option>
                            <option value="AP">Amapá</option>
                            <option value="AM">Amazonas</option>
                            <option value="BA">Bahia</option>
                            <option value="CE">Ceará</option>
                            <option value="DF">Distrito Federal</option>
                            <option value="ES">Espírito Santo</option>
                            <option value="GO">Goiás</option>
                            <option value="MA">Maranhão</option>
                            <option value="MT">Mato Grosso</option>
                            <option value="MS">Mato Grosso do Sul</option>
                            <option value="MG">Minas Gerais</option>
                            <option value="PA">Pará</option>
                            <option value="PB">Paraíba</option>
                            <option value="PR">Paraná</option>
                            <option value="PE">Pernambuco</option>
                            <option value="PI">Piauí</option>
                            <option value="RJ">Rio de Janeiro</option>
                            <option value="RN">Rio Grande do Norte</option>
                            <option value="RS">Rio Grande do Sul</option>
                            <option value="RO">Rondônia</option>
                            <option value="RR">Roraima</option>
                            <option value="SC">Santa Catarina</option>
                            <option value="SP">São Paulo</option>
                            <option value="SE">Sergipe</option>
                            <option value="TO">Tocantins</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="telefone">Telefone</label>
                        <input type="tel" id="terapeuta_telefone" name="terapeuta_telefone" disabled>
                    </div>
                    <div class="form-group">
                        <label for="celular">Celular (WhatsApp)</label>
                        <input type="tel" id="terapeuta_celular" name="terapeuta_celular" disabled>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="terapeuta_email" name="terapeuta_email" disabled>
                    </div>
                    <div class="form-group">
                        <label for="cpf">CPF</label>
                        <input type="text" id="terapeuta_cpf" name="terapeuta_cpf" disabled>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Endereço do Consultório</label>
                        <input type="text" id="terapeuta_endereco_consultorio" name="terapeuta_endereco_consultorio" disabled>
                        <div class="checkbox-group" style="margin-top: 8px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="terapeuta_online" name="terapeuta_online" style="margin: 0;" onchange="toggleConsultorioAcessivel()" disabled>
                            <label style="margin: 0;">Somente atendimento online</label>
                        </div>
                    </div>
                </div>

                <div class="form-row" id="consultorio-acessivel-row">
                    <div class="form-group">
                        <label>Seu consultório tem acesso facilitado para pessoas com mobilidade reduzida?</label>
                        <select id="terapeuta_consultorio_acessivel" name="terapeuta_consultorio_acessivel" disabled onchange="toggleOutroAcesso()">
                            <option value="true">Sim</option>
                            <option value="false">Não</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group" id="consultorio-acessivel-outro-group" style="display: none;">
                        <label >Descreva o acesso facilitado para pessoas com mobilidade reduzida</label>
                        <input type="text" id="terapeuta_observacao_acessibilidade" name="terapeuta_observacao_acessibilidade" disabled>
                    </div>
                </div>
                <h3>Formação e Certificações</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Nível Atual</label>
                        <select id="terapeuta_nivel_atual" name="terapeuta_nivel_atual" disabled onchange="toggleCartaRecomendacao()">
                            <option value="">Selecione o Nível</option>
                            <option value="Avançado Completo">Avançado Completo</option>
                            <option value="Certificado SEP">Certificado SEP</option>
                            <option value="Supervisor">Supervisor</option>
                        </select>
                    </div>
                </div>

                <div class="form-row" id="carta-recomendacao-row" style="display: none;">
                    <div class="form-group">
                        <label>Carta de Recomendação (PDF)</label>
                        <iframe 
                            src="{{ url_for('cartas_recomendacao', filename='') }}"
                            width="100%" 
                            height="500px" 
                            style="border: 1px solid #ddd; border-radius: 4px;"
                            id="terapeuta_carta_recomendacao">
                        </iframe>
                        <label class="observacao">Se você concluiu o Avançado 2 mas ainda não obteve o SEP, anexar uma carta de recomendação de um dos professores salva em pdf.</label>
                    </div>
                </div>

                <div class="form-row" id="comprovante-sessoes-row" style="display: none;">
                    <div class="form-group">
                        <label>Comprovante de participação em sessões pessoais</label>
                        <iframe 
                            src="{{ url_for('comprovantes_sessoes', filename='') }}"
                            width="100%" 
                            height="500px" 
                            style="border: 1px solid #ddd; border-radius: 4px;"
                            id="terapeuta_comprovante_sessoes">
                        </iframe>
                    </div>
                </div>

                <div class="form-group">
                    <label>Ano de Conclusão do Avançado 2:</label>
                    <input type="number" id="terapeuta_ano_conclusao_avancado2" name="terapeuta_ano_conclusao_avancado2" disabled>
                </div>
                <h3>Informações Adicionais</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Ano de conclusão do SEP:</label>
                            <input type="number" id="terapeuta_ano_conclusao_sep" name="terapeuta_ano_conclusao_sep" disabled>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Quem foram seus professores na formação em SE?</label>
                            <input type="text" id="terapeuta_professores_formacao" name="terapeuta_professores_formacao" disabled>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Você participa atualmente de grupos de estudo em SE?</label>
                            <select id="terapeuta_participa_grupo_estudo" name="terapeuta_participa_grupo_estudo" disabled>
                                <option value="true">Sim</option>
                                <option value="false">Não</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Você participa de sessões de supervisão de casos? </label>
                            <select id="terapeuta_supervisao_casos" name="terapeuta_supervisao_casos" disabled onchange="toggleNumeroSupervisoes()">
                                <option value="sim">Sim</option>
                                <option value="nao">Não</option>
                            </select>
                        </div>
                        <div class="form-group" id="numero-supervisoes-group" style="display: none;">
                            <label>De quantas supervisões você participou no último ano? </label>
                            <input type="number" id="terapeuta_numero_supervisoes_ultimo_ano" name="terapeuta_numero_supervisoes_ultimo_ano" disabled>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Qual a sua formação acadêmica?</label>
                            <input type="text" id="terapeuta_formacao_academica" name="terapeuta_formacao_academica" disabled>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Gostaria de participar da produção científica da ABT?</label>
                            <select id="terapeuta_interesse_producao_cientifica" name="terapeuta_interesse_producao_cientifica" disabled>
                                <option value="true">Sim</option>
                                <option value="false">Não</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Modalidade do Atendimento:</label>
                            <select id="terapeuta_modalidade" name="terapeuta_modalidade" disabled>
                                <option value="presencial">Presencial</option>
                                <option value="online">Online</option>
                                <option value="presencial_online">Online e Presencial</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Tem alguma sugestão para o NAPESE?</label>
                            <input type="text" id="terapeuta_sugestoes" name="terapeuta_sugestoes" disabled>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>É associado da ABT?</label>
                            <select id="terapeuta_associado_abt" name="terapeuta_associado_abt" disabled>
                                <option value="true">Sim</option>
                                <option value="false">Não</option>
                            </select>
                        </div>
                    </div>
            </div>
        
            <hr>
            <div class="" style="display: block;">
                
                <div class="form-row">
                
                    <div class="form-col">
                        <div class="form-group">
                            <!--<h3>Avaliação do Terapeuta</h3> -->
                            <div>
                                <button onclick="aprovarTerapeuta()" class="action-btn edit-btn">Aprovar</button>
                                <button onclick="negarTerapeuta()"  class="action-btn delete-btn">Negar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <form action="{{ url_for('remover_vinculo') }}" method="POST" style="display:none;" id="formRemoverVinculo">
        {{ form.csrf_token }}
        <input type="hidden" name="terapeuta_id" id="terapeuta_remover_id">
        <input type="hidden" name="paciente_id" id="paciente_remover_id">
        <button type="submit" id="btnRemoverVinculo">
        </button>
    </form>

    <script>
        // Função para abrir o modal e preencher os campos
        function openEditUserModal(userId, email) {
            document.getElementById('editModal').style.display = "flex";
            document.getElementById('email').value = email;  // Preenche o email no formulário
            document.getElementById('user_id').value = userId;  // Preenche o ID do usuário
        }

        // Função para fechar o modal
        function closeEditUserModal() {
            document.getElementById('editModal').style.display = "none";
        }

        function pacientes_reprovados_excel(){
            fetch('/gerar_excel_reprovados_pacientes')
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    }
                    throw new Error('Erro ao gerar Excel');
                })
                .then(blob => {
                    // Criar URL do blob
                    const url = window.URL.createObjectURL(blob);
                    // Criar link temporário
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'pacientes_reprovados.xlsx'; // Nome do arquivo
                    // Adicionar à página e clicar
                    document.body.appendChild(a);
                    a.click();
                    // Limpar
                    window.URL.revokeObjectURL(url);
                    a.remove();
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao gerar arquivo Excel');
                });
        }

        function terapeutas_reprovados_excel(){
            fetch('/gerar_excel_reprovados_terapeutas', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}',
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'  // Importante para enviar cookies de autenticação
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Erro ao gerar Excel');
            })
            .then(blob => {
                // Criar URL do blob
                const url = window.URL.createObjectURL(blob);
                // Criar link temporário
                const a = document.createElement('a');
                a.href = url;
                a.download = 'terapeutas_reprovados.xlsx'; // Nome do arquivo
                // Adicionar à página e clicar
                document.body.appendChild(a);
                a.click();
                // Limpar
                window.URL.revokeObjectURL(url);
                a.remove();
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao gerar arquivo Excel');
            });
        }

        function openAvaliarTerapeutaModal(userId, email) {
            document.getElementById('avaliarTerapeutaModal').style.display = "flex";
            // document.getElementById('email').value = email;  // Preenche o email no formulário
            // document.getElementById('user_id').value = userId;  // Preenche o ID do usuário

            const selectPaciente = document.getElementById('novo_paciente');

            // Limpar as opções existentes
            selectPaciente.innerHTML = '<option value="" disabled selected>Selecione um paciente</option>';

            fetch(`/avaliacao_terapeuta/${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        document.getElementById('avaliar_terapeuta_id').value = data[0].id;
                        document.getElementById('terapeuta_nome_completo').value = data[0].nome_completo;
                        document.getElementById('terapeuta_cidade').value = data[0].cidade;
                        document.getElementById('terapeuta_estado').value = data[0].estado;
                        document.getElementById('terapeuta_email').value = data[0].email;
                        document.getElementById('terapeuta_telefone').value = data[0].telefone;
                        document.getElementById('terapeuta_celular').value = data[0].celular;
                        document.getElementById('terapeuta_cpf').value = data[0].cpf;
                        document.getElementById('terapeuta_online').value = data[0].online;
                        document.getElementById('terapeuta_endereco_consultorio').value = data[0].endereco_consultorio;
                        document.getElementById('terapeuta_consultorio_acessivel').value = data[0].consultorio_acessivel;
                        //fazer observaçao surgir caso consultorio_acessivel!= 'sim'
                        document.getElementById('terapeuta_observacao_acessibilidade').value = data[0].observacao_acessibilidade;
                        document.getElementById('terapeuta_nivel_atual').value = data[0].nivel_atual;
                        function toggleCartaRecomendacao() {
                            const nivelSelect = document.getElementById('terapeuta_nivel_atual');
                            const cartaRow = document.getElementById('carta-recomendacao-row');
                            const comprovanteRow = document.getElementById('comprovante-sessoes-row');
                            const cartaInput = document.getElementById('terapeuta_carta_recomendacao');
                            const comprovanteInput = document.getElementById('terapeuta_comprovante_sessoes');
                            
                            if (nivelSelect.value === 'Avançado Completo') {
                                cartaRow.style.display = 'flex';
                                comprovanteRow.style.display = 'flex';
                                cartaInput.required = true;
                                if (data[0].carta_recomendacao_path) {
                                    const baseUrl = "{{ url_for('cartas_recomendacao', filename='') }}";
                                    cartaInput.src = baseUrl + data[0].carta_recomendacao_path;
                                }
                                if (data[0].comprovante_sessoes_path) {
                                    const baseUrl = "{{ url_for('comprovantes_sessoes', filename='') }}";
                                    comprovanteInput.src = baseUrl + data[0].comprovante_sessoes_path;
                                }
                            } else {
                                cartaRow.style.display = 'none';
                                comprovanteRow.style.display = 'none';
                                cartaInput.required = false;
                                cartaInput.src = '';
                                comprovanteInput.src = '';
                            }
                        }

                        // Executar a verificação inicial do campo carta de recomendação
                        toggleCartaRecomendacao();
                        document.getElementById('terapeuta_ano_conclusao_avancado2').value = data[0].ano_conclusao_avancado2;
                        document.getElementById('terapeuta_ano_conclusao_sep').value = data[0].ano_conclusao_sep;
                        document.getElementById('terapeuta_professores_formacao').value = data[0].professores_formacao;
                        document.getElementById('terapeuta_participa_grupo_estudo').value = data[0].participa_grupo_estudo;
                        if(data[0].numero_supervisoes_ultimo_ano > 0){
                            document.getElementById('terapeuta_supervisao_casos').value = "sim";
                            document.getElementById('terapeuta_numero_supervisoes_ultimo_ano').value = data[0].numero_supervisoes_ultimo_ano;
                        } else {
                            document.getElementById('terapeuta_supervisao_casos').value = "nao";
                            document.getElementById('terapeuta_numero_supervisoes_ultimo_ano').value = 0;
                        }
                        document.getElementById('terapeuta_formacao_academica').value = data[0].formacao_academica;
                        document.getElementById('terapeuta_interesse_producao_cientifica').value = data[0].interesse_producao_cientifica;
                        document.getElementById('terapeuta_modalidade').value = data[0].modalidade;
                        document.getElementById('terapeuta_sugestoes').value = data[0].sugestoes;
                        document.getElementById('terapeuta_associado_abt').value = data[0].associado_abt;
                        //add a pdf visializator
                        // document.getElementById('terapeuta_carta_recomendacao_path').value = data[0].carta_recomendacao_path;
                        
                        const dt = new Date(data[0].data_nascimento );
                        dt.setDate(dt.getDate() + 1);
                        const dia = dt.getDate().toString().padStart(2, '0');
                    } 
                })
        }

        function closeAvaliarTerapeutaModal() {
            document.getElementById('avaliarTerapeutaModal').style.display = "none";
        }

        function openAvaliarPacienteModal(userId, email) {
            document.getElementById('avaliarPacientesModal').style.display = "flex";
            // document.getElementById('email').value = email;  // Preenche o email no formulário
            // document.getElementById('user_id').value = userId;  // Preenche o ID do usuário

            const selectPaciente = document.getElementById('novo_paciente');

            // Limpar as opções existentes
            selectPaciente.innerHTML = '<option value="" disabled selected>Selecione um paciente</option>';

            // Fazer requisição à API para obter pacientes disponíveis
            fetch(`/avaliacao_paciente/${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        document.getElementById('avaliar_paciente_id').value = data[0].id;
                        document.getElementById('nome_completo').value = data[0].nome_completo;
                        document.getElementById('cpf').value = data[0].cpf;
                        document.getElementById('telefones').value = data[0].telefones;
                        const dt = new Date(data[0].data_nascimento );
                        dt.setDate(dt.getDate() + 1);
                        const dia = dt.getDate().toString().padStart(2, '0');
                        const mes = (dt.getMonth() + 1).toString().padStart(2, '0');
                        const ano = dt.getFullYear();
                        document.getElementById('data_nascimento').value = `${dia}/${mes}/${ano}`;
                        document.getElementById('cep').value = data[0].cep;
                        document.getElementById('cidade').value = data[0].cidade;
                        document.getElementById('estado').value = data[0].estado;
                        document.getElementById('genero').value = data[0].genero;
                        document.getElementById('profissao').value = data[0].profissao;
                        document.getElementById('preferencia_atendimento').value = data[0].preferencia_atendimento;
                        document.getElementById('renda_familiar').value = data[0].renda_familiar;
                        document.getElementById('num_dependentes').value = data[0].num_dependentes;
                        document.getElementById('conheceu_site_trauma').checked = data[0].conheceu_site_trauma;
                        document.getElementById('conheceu_instagram').checked = data[0].conheceu_instagram;
                        document.getElementById('conheceu_indicacao').checked = data[0].conheceu_indicacao;
                        document.getElementById('conheceu_treinamentos').checked = data[0].conheceu_treinamentos;
                        document.getElementById('conheceu_google').checked = data[0].conheceu_google;
                        document.getElementById('conheceu_rede_social').checked = data[0].conheceu_rede_social;
                        document.getElementById('conheceu_psicologo').checked = data[0].conheceu_psicologo;
                        document.getElementById('conhece_se').value = data[0].conhece_se;
                        document.getElementById('conheceu_outro').value = data[0].conheceu_outro;
                        document.getElementById('sintomas_relevantes').value = data[0].sintomas_relevantes;
                        document.getElementById('medicacoes').value = data[0].medicacoes;
                        document.getElementById('substancias_psicoativas').value = data[0].substancias_psicoativas;
                        document.getElementById('historico_acidentes').value = data[0].historico_acidentes;
                        document.getElementById('historico_cirurgias').value = data[0].historico_cirurgias;
                        document.getElementById('dores').value = data[0].dores;
                        document.getElementById('acompanhamento_psiquiatrico').value = data[0].acompanhamento_psiquiatrico;
                        document.getElementById('acompanhamento_psicologico').value = data[0].acompanhamento_psicologico;
                        document.getElementById('tecnicas_corporais').value = data[0].tecnicas_corporais;
                        document.getElementById('descricao_evento').value = data[0].descricao_evento;
                        document.getElementById('tempo_decorrido').value = data[0].tempo_decorrido;
                        document.getElementById('envolveu_violencia').value = data[0].envolveu_violencia;
                        document.getElementById('vivenciou_trauma').value = data[0].vivenciou_trauma;
                        // document.getElementById('envolveu_morte').value = data[0].envolveu_morte;
                        document.getElementById('vivencia_direta').checked = data[0].vivencia_direta;
                        document.getElementById('vivencia_testemunha').checked = data[0].vivencia_testemunha;
                        document.getElementById('vivencia_familiar_amigo').checked = data[0].vivencia_familiar_amigo;
                        document.getElementById('vivencia_trabalho').checked = data[0].vivencia_trabalho;
                        document.getElementById('vivencia_nenhuma').checked = data[0].vivencia_nenhuma;
                        document.getElementById('vivencia_outro').value = data[0].vivencia_outro;
                        document.getElementById('motivo_procura').value = data[0].motivo_procura;
                        document.getElementById('acidente_violencia').checked = data[0].acidente_violencia;
                        document.getElementById('causas_naturais').checked = data[0].causas_naturais;
                        document.getElementById('nao_se_aplica').checked = data[0].nao_se_aplica;
                        document.getElementById('impacto_soma').innerHTML  =  "Resultado da soma: "+(data[0].impacto_perda_interesse + data[0].impacto_apreensao + data[0].impacto_evitar_gatilhos+ data[0].impacto_chateado+ data[0].impacto_concentracao+ data[0].impacto_crencas+ data[0].impacto_lembracas + data[0].impacto_evitacao);

                        toggleTraumaFields(data[0].vivenciou_trauma);

                        document.getElementById('impacto_lembracas').value = data[0].impacto_lembracas;
                        inputs_lembrancas = document.getElementById('impacto_lembracas');
                        updateValue(inputs_lembrancas);


                        document.getElementById('impacto_evitacao').value = data[0].impacto_evitacao;
                        inputs_evitacao = document.getElementById('impacto_evitacao');
                        updateValue(inputs_evitacao);

                        document.getElementById('impacto_crencas').value = data[0].impacto_crencas;
                        inputs_crencas = document.getElementById('impacto_crencas');
                        updateValue(inputs_crencas);

                        document.getElementById('impacto_concentracao').value = data[0].impacto_concentracao;
                        inputs_concentracao = document.getElementById('impacto_concentracao');
                        updateValue(inputs_concentracao);

                        document.getElementById('impacto_chateado').value = data[0].impacto_chateado;
                        inputs_chateado = document.getElementById('impacto_chateado');
                        updateValue(inputs_chateado);

                        document.getElementById('impacto_evitar_gatilhos').value = data[0].impacto_evitar_gatilhos;
                        inputs_evitar_gatilhos = document.getElementById('impacto_evitar_gatilhos');
                        updateValue(inputs_evitar_gatilhos);

                        document.getElementById('impacto_apreensao').value = data[0].impacto_apreensao;
                        inputs_apreensao = document.getElementById('impacto_apreensao');
                        updateValue(inputs_apreensao);

                        document.getElementById('impacto_perda_interesse').value = data[0].impacto_perda_interesse;
                        inputs_perda_interesse = document.getElementById('impacto_perda_interesse');
                        updateValue(inputs_perda_interesse);
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar pacientes disponíveis:', error);
                });
        }

        function updateValue(input) {
            const valueTexts = [
                'De modo nenhum',
                'Um pouco',
                'Moderadamente',
                'Muito',
                'Extremamente'
            ];
                            
            const valueDisplay = input.closest('.likert-item').querySelector('.likert-value');
            if (valueDisplay) {
                
                switch(valueTexts[input.value]){
                    case "De modo nenhum":
                        input.style.cssText = "background: linear-gradient(to right, var(--secondary) var(--value-percent, 0%), var(--gray-50) var(--value-percent, 0%))";
                        break
                    case "Um pouco":
                        input.style.cssText = "background: linear-gradient(to right, var(--secondary) var(--value-percent, 25%), var(--gray-50) var(--value-percent, 25%))";
                        break
                    case "Moderadamente":
                        input.style.cssText = "background: linear-gradient(to right, var(--secondary) var(--value-percent, 50%), var(--gray-50) var(--value-percent, 50%))";
                        break
                    case "Muito":
                        input.style.cssText = "background: linear-gradient(to right, var(--secondary) var(--value-percent, 75%), var(--gray-50) var(--value-percent, 75%))";
                        break
                    case "Extremamente":
                        input.style.cssText = "background: linear-gradient(to right, var(--secondary) var(--value-percent, 100%), var(--gray-50) var(--value-percent, 100%))";
                        break
                }

                valueDisplay.textContent = valueTexts[input.value];
            }
        }

        function closeAvaliarPacientesModal() {
            document.getElementById('avaliarPacientesModal').style.display = "none";
        }

        function openCreateUserModal() {
            document.getElementById('createUserModal').style.display = "flex";
        }

        function closeCreateUserModal() {
            document.getElementById('createUserModal').style.display = "none";
        }

        function aprovarTerapeuta(){
            const avaliar_terapeuta_id = document.getElementById('avaliar_terapeuta_id').value;
            fetch(`/definir_status_terapeuta/${avaliar_terapeuta_id}/aprovado`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => {
                if (response.ok) {
                    alert('Terapeuta aprovado com sucesso!');
                    window.location.reload();
                } else {
                    throw new Error('Erro ao processar a requisição');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.innerHTML = `
                    Erro ao processar a requisição
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            });
            
            closeAvaliarTerapeutaModal();
        }

        function negarTerapeuta(){
            const avaliar_terapeuta_id = document.getElementById('avaliar_terapeuta_id').value;
            fetch(`/definir_status_terapeuta/${avaliar_terapeuta_id}/reprovado`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => {
                if (response.ok) {
                    alert('Terapeuta reprovado com sucesso!');
                    window.location.reload();
                } else {
                    throw new Error('Erro ao processar a requisição');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.innerHTML = `
                    Erro ao processar a requisição
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            });
            
            closeAvaliarTerapeutaModal();
        }

        function aprovarPaciente(){
            const avaliar_paciente_id = document.getElementById('avaliar_paciente_id').value;
            fetch(`/definir_status_paciente/${avaliar_paciente_id}/aprovado`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => {
                if (response.ok) {
                    alert('Paciente aprovado com sucesso!');
                    window.location.reload();
                } else {
                    throw new Error('Erro ao processar a requisição');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.innerHTML = `
                    Erro ao processar a requisição
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            });
            
            closeAvaliarPacientesModal();
        }

        function negarPaciente(){
            const avaliar_paciente_id = document.getElementById('avaliar_paciente_id').value;
            fetch(`/definir_status_paciente/${avaliar_paciente_id}/reprovado`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => {
                if (response.ok) {
                    alert('Paciente reprovado com sucesso!');
                    window.location.reload();
                } else {
                    throw new Error('Erro ao processar a requisição');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.innerHTML = `
                    Erro ao processar a requisição
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            });
            
            closeAvaliarPacientesModal();
        }

        function buscarPacientesDisponiveis(){
            // const terapeutaId = document.getElementById('terapeuta_id').value;
            const selectPaciente = document.getElementById('novo_paciente');

            // Limpar as opções existentes
            selectPaciente.innerHTML = '<option value="" disabled selected>Selecione um paciente</option>';

            // Fazer requisição à API para obter pacientes disponíveis
            fetch(`/pacientes_disponiveis`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        data.forEach(paciente => {
                            const option = document.createElement('option');
                            option.value = paciente.id;
                            option.textContent = paciente.email;
                            selectPaciente.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar pacientes disponíveis:', error);
                });
        };

        function openVincularPacientesModal(terapeutaId) {
            buscarPacientesDisponiveis();

            document.getElementById('vincularPacientesModal').style.display = 'flex';
            document.getElementById('terapeuta_id').value = terapeutaId;

            // Fazer a requisição AJAX para buscar pacientes
            loadPacientes(terapeutaId);
        }

        function loadPacientes(terapeutaId) {
            const tbody = document.getElementById(`pacientes-ul`);
            
            fetch(`/get_pacientes/${terapeutaId}`)
                .then(response => response.json())
                .then(pacientes => {
                    tbody.innerHTML = '';
                    
                    if (pacientes.length === 0) {
                        tbody.innerHTML = '<div class="no-pacientes">Nenhum paciente vinculado</div>';
                    } else {
                        pacientes.forEach(paciente => {
                            const div = document.createElement('div');
                            div.className = 'paciente-item';
                            div.innerHTML = `
                                <div class="paciente-info">
                                    <i class="fas fa-user"></i>
                                    <span class="paciente-email">${paciente.email}</span>
                                </div>
                                <button class="btn-remover" onclick="removerVinculo(${terapeutaId}, ${paciente.id})" title="Remover vínculo">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            tbody.appendChild(div);
                        });
                    }
                })
                .catch(error => console.error('Erro ao carregar pacientes:', error));
        }

        function removerVinculo(terapeutaId, pacienteId) {
            if (!confirm('Tem certeza que deseja remover este vínculo?')) return;

            // Definindo os valores dos campos ocultos
            document.getElementById('terapeuta_remover_id').value = terapeutaId;
            document.getElementById('paciente_remover_id').value = pacienteId;

            // Submetendo o formulário programaticamente
            document.getElementById('formRemoverVinculo').submit();
        }

        function closeVincularPacientesModal() {
            document.getElementById('vincularPacientesModal').style.display = 'none';
        }

        // Fechar o modal se o usuário clicar fora da área do modal
        window.onclick = function(event) {
            if (event.target == document.getElementById('editModal')) {
                closeEditUserModal();
            }
            if (event.target == document.getElementById('createUserModal')) {
                closeCreateUserModal();
            }
            if (event.target == document.getElementById('vincularPacientesModal')) {
                closeVincularPacientesModal();
            }
        }

        function fecharAlerta(botao) {
            const alerta = botao.parentElement;
            alerta.style.transition = "opacity 0.5s";
            alerta.style.opacity = "0";

            setTimeout(() => {
                alerta.remove();
            }, 500); // Tempo para a animação de transição antes de remover o elemento
        }

        // Configuração da paginação
        const ITEMS_PER_PAGE = 5;
        let adminTerapeutaData = [];
        let pacienteData = [];
        let adminTerapeutaCurrentPage = 1;
        let pacienteCurrentPage = 1;

        // Inicializar os dados
        window.onload = function() {
            // Separar os dados em duas arrays
            {% for user in usuarios['items'] %}
                {% if user.tipo_usuario in ['admin', 'terapeuta'] %}
                    adminTerapeutaData.push({
                        id: '{{ user.id }}',
                        email: '{{ user.email }}',
                        tipo: '{{ user.tipo_usuario }}'
                    });
                {% endif %}
                {% if user.tipo_usuario == 'paciente' %}
                    pacienteData.push({
                        id: '{{ user.id }}',
                        nome_completo: '{{ user.nome_completo }}',
                        email: '{{ user.email }}'
                    });
                {% endif %}
            {% endfor %}

            // Renderizar as tabelas iniciais
            renderAdminTerapeutaTable();
            renderPacienteTable();

            // Adicionar dados dos vínculos
            {% for vinculo in vinculos['items'] %}
                vinculosData.push({
                    nome_terapeuta: '{{ vinculo.nome_terapeuta }}',
                    nome_paciente: '{{ vinculo.nome_paciente }}',
                    data_vinculo: '{{ vinculo.data_vinculo }}',
                    status_vinculo: '{{ vinculo.status_vinculo }}'
                });
            {% endfor %}

            // Renderizar todas as tabelas
            renderAdminTerapeutaTable();
            renderPacienteTable();
            renderVinculosTable();
        };

        function renderAdminTerapeutaTable() {
            const tbody = document.querySelector('#admin-terapeuta-table tbody');
            const start = (adminTerapeutaCurrentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageData = adminTerapeutaData.slice(start, end);

            tbody.innerHTML = '';
            pageData.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.email}</td>
                    <td class="actions-cell">
                        <button class="action-btn edit-btn" 
                            onclick="openEditUserModal('${user.id}', '${user.email}')" 
                            title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <form action="/remover-usuario/${user.id}" method="POST" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" 
                                class="action-btn delete-btn" 
                                onclick="return confirm('Tem certeza que deseja remover este usuário?')" 
                                title="Remover">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                        ${user.tipo === 'terapeuta' ? `
                            <button class="action-btn link-btn" 
                                onclick="openVincularPacientesModal('${user.id}')"
                                title="Vincular Pacientes">
                                <i class="fas fa-link"></i>
                            </button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('admin-terapeuta-current-page').textContent = adminTerapeutaCurrentPage;
            
            // Atualizar estado dos botões de paginação
            const prevBtn = document.querySelector('#admin-terapeuta-pagination button:first-child');
            const nextBtn = document.querySelector('#admin-terapeuta-pagination button:last-child');
            prevBtn.disabled = adminTerapeutaCurrentPage === 1;
            nextBtn.disabled = end >= adminTerapeutaData.length;
        }

        function renderPacienteTable() {
            const tbody = document.querySelector('#paciente-table tbody');
            const start = (pacienteCurrentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageData = pacienteData.slice(start, end);

            tbody.innerHTML = '';
            pageData.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.nome_completo}</td>
                    <td class="actions-cell">
                        <button class="action-btn edit-btn" 
                            onclick="openEditUserModal('${user.id}', '${user.email}')" 
                            title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <form action="/remover-usuario/${user.id}" method="POST" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" 
                                class="action-btn delete-btn" 
                                onclick="return confirm('Tem certeza que deseja remover este usuário?')" 
                                title="Remover">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                        <form action="/gerar_pdf/${user.email}" method="GET" style="display:inline;">
                            <button type="submit" 
                                class="action-btn pdf-btn" 
                                title="Gerar PDF">
                                <i class="fas fa-file-pdf"></i>
                            </button>
                        </form>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('paciente-current-page').textContent = pacienteCurrentPage;
            
            // Atualizar estado dos botões de paginação
            const prevBtn = document.querySelector('#paciente-pagination button:first-child');
            const nextBtn = document.querySelector('#paciente-pagination button:last-child');
            prevBtn.disabled = pacienteCurrentPage === 1;
            nextBtn.disabled = end >= pacienteData.length;
        }

        function changePage(type, direction) {
            if (type === 'admin-terapeuta') {
                const newPage = adminTerapeutaCurrentPage + direction;
                const maxPage = Math.ceil(adminTerapeutaData.length / ITEMS_PER_PAGE);
                if (newPage >= 1 && newPage <= maxPage) {
                    adminTerapeutaCurrentPage = newPage;
                    renderAdminTerapeutaTable();
                }
            } else if (type === 'paciente') {
                const newPage = pacienteCurrentPage + direction;
                const maxPage = Math.ceil(pacienteData.length / ITEMS_PER_PAGE);
                if (newPage >= 1 && newPage <= maxPage) {
                    pacienteCurrentPage = newPage;
                    renderPacienteTable();
                }
            } else if (type === 'vinculos') {
                const newPage = vinculosCurrentPage + direction;
                const maxPage = Math.ceil(vinculosData.length / ITEMS_PER_PAGE);
                if (newPage >= 1 && newPage <= maxPage) {
                    vinculosCurrentPage = newPage;
                    renderVinculosTable();
                }
            }
        }

        // Atualizar a função de filtro para trabalhar com ambas as tabelas
        function filtrarTabela() {
            const filtro = document.getElementById('filtro-tabela').value.toUpperCase();
            
            // Filtrar admin/terapeuta
            const adminTerapeutaRows = document.querySelectorAll('#admin-terapeuta-table tbody tr');
            adminTerapeutaRows.forEach(row => {
                const email = row.cells[0].textContent.toUpperCase();
                row.style.display = email.includes(filtro) ? '' : 'none';
            });
            
            // Filtrar pacientes
            const pacienteRows = document.querySelectorAll('#paciente-table tbody tr');
            pacienteRows.forEach(row => {
                const email = row.cells[0].textContent.toUpperCase();
                row.style.display = email.includes(filtro) ? '' : 'none';
            });

            // Filtrar vínculos
            const vinculoRows = document.querySelectorAll('#vinculos-table tbody tr');
            vinculoRows.forEach(row => {
                const terapeuta = row.cells[0].textContent.toUpperCase();
                const paciente = row.cells[1].textContent.toUpperCase();
                row.style.display = (terapeuta.includes(filtro) || paciente.includes(filtro)) ? '' : 'none';
            });
        }

        function toggleTraumaFields(vivenciouTrauma) {
            const detalhesTrauma = document.getElementById('detalhes-trauma');
            const envolveuMorteGrupo = document.getElementById('envolveu-morte-grupo');
            const vivenciaGrupo = document.getElementById('vivencias-grupo');
            if (vivenciouTrauma) {
                detalhesTrauma.style.display = 'grid';
                envolveuMorteGrupo.style.display = 'grid';
                vivenciaGrupo.style.display = 'grid';
            } else {
                detalhesTrauma.style.display = 'none';
                envolveuMorteGrupo.style.display = 'none';
                vivenciaGrupo.style.display = 'none';
            }
        }

        // Adicionar array para os vínculos
        let vinculosData = [];

        // Adicionar função para renderizar tabela de vínculos
        function renderVinculosTable() {
            const tbody = document.querySelector('#vinculos-table tbody');
            const start = (vinculosCurrentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageData = vinculosData.slice(start, end);

            tbody.innerHTML = '';
            pageData.forEach(vinculo => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vinculo.nome_terapeuta}</td>
                    <td>${vinculo.nome_paciente}</td>
                    <td>${vinculo.data_vinculo}</td>
                    <td>
                        <span class="badge badge-${vinculo.status_vinculo === 'Ativo' ? 'terapeuta' : 'paciente'}">
                            ${vinculo.status_vinculo}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('vinculos-current-page').textContent = vinculosCurrentPage;
            
            // Atualizar estado dos botões de paginação
            const prevBtn = document.querySelector('#vinculos-pagination button:first-child');
            const nextBtn = document.querySelector('#vinculos-pagination button:last-child');
            prevBtn.disabled = vinculosCurrentPage === 1;
            nextBtn.disabled = end >= vinculosData.length;
        }

        // Adicionar variável de página atual para vínculos
        let vinculosCurrentPage = 1;

        function vincularPaciente(event) {
            event.preventDefault();
            
            const formData = new FormData(document.getElementById('vincularPacientesForm'));
            
            fetch('{{ url_for("vincular_paciente") }}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                alert('Erro ao vincular paciente. Por favor, tente novamente.');
            });
        }
    </script>
</body>
</html>